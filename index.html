<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkyNexaHost</title>
  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#0a0a0a; color:white;}
    #auth, #dashboard, #workspace, #previewArea {display:none;}
    #auth, #dashboard, #workspace {height:100vh;}

    /* Auth */
    #auth {display:flex; align-items:center; justify-content:center;}
    #authCard {background:#111; padding:20px; border-radius:10px; text-align:center;}
    #authCard input, #authCard button {margin:5px; padding:10px;}
    #authCard input[type="file"]{color:white;}

    /* Dashboard */
    #dashboard {display:flex;}
    #friendList {width:200px; background:#111; padding:10px; overflow-y:auto;}
    #friendList h3 {margin:0 0 10px 0; font-size:16px;}
    #mainDash {flex:1; padding:20px;}
    .project-box {background:#222; padding:15px; margin:10px; border-radius:8px; cursor:pointer;}
    .profile-box {background:#222; padding:15px; border-radius:8px; margin-bottom:20px;}

    /* Workspace */
    #workspace {display:flex;}
    #sidebar {width:200px; background:#111; padding:10px;}
    #editorArea {flex:1; display:flex; flex-direction:column;}
    #editor {flex:1;}

    /* Buttons */
    button {background:#00ffea; border:none; color:#000; border-radius:5px; cursor:pointer;}
    button:hover {opacity:0.8;}

    /* Preview */
    #previewArea {position:fixed; top:0; left:0; width:100%; height:100%; background:black; display:none;}
    #previewFrame {width:100%; height:100%; border:none;}
    #closePreviewBtn {position:absolute; top:10px; right:10px;}
  </style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div id="authCard">
    <h2>SkyNexaHost Login</h2>
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <input type="file" id="profilePic"><br>
    <button id="signUpBtn">Sign Up</button>
    <button id="logInBtn">Log In</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <!-- Friend List -->
  <div id="friendList">
    <h3>Friends</h3>
    <ul id="friends"></ul>
  </div>
  
  <div id="mainDash">
    <button id="logoutBtn">Logout</button>
    <h2>Dashboard</h2>

    <!-- Profile Info -->
    <div class="profile-box">
      <img id="profileImage" src="" alt="Profile" width="80" height="80" style="border-radius:50%;"><br>
      <strong id="displayName"></strong><br>
      <span id="displayDesc"></span><br>
      <button id="editProfileBtn">Edit Profile</button>
    </div>

    <button id="newProjectBtn">+ New Project</button>
    <div id="projects"></div>
  </div>
</div>

<!-- WORKSPACE -->
<div id="workspace">
  <div id="sidebar">
    <button id="addFileBtn">+ Add File</button>
    <ul id="fileList"></ul>
  </div>
  <div id="editorArea">
    <div style="display:flex; justify-content:space-between;">
      <button id="saveBtn">Save</button>
      <button id="previewBtn">Preview</button>
    </div>
    <div id="editor" style="width:100%; height:100%; background:#1e1e1e; color:white;"></div>
  </div>
</div>

<!-- PREVIEW -->
<div id="previewArea">
  <iframe id="previewFrame"></iframe>
  <button id="closePreviewBtn">Close</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.0/ace.js"></script>
<script>
  // ===== GLOBALS =====
  let currentUser=null, currentProject=null, currentFile=null, editor;

  // ===== INIT =====
  window.onload=()=>{
    if(localStorage.getItem("skynexa_loggedIn")){
      currentUser=localStorage.getItem("skynexa_loggedIn");
      showDashboard();
    } else {
      document.getElementById("auth").style.display="flex";
    }
  };

  // ===== AUTH =====
  function signUp(){
    let u=document.getElementById("username").value.trim();
    let p=document.getElementById("password").value.trim();
    let pic=document.getElementById("profilePic").files[0];
    if(!u||!p){alert("Enter username & password");return;}
    if(localStorage.getItem("user_"+u)){alert("User exists");return;}
    let reader=new FileReader();
    reader.onload=function(e){
      let user={password:p, projects:{}, friends:[], profile:{name:u, desc:"", pic:e.target.result||"https://i.ibb.co/ZVFsg37/default.png"}};
      localStorage.setItem("user_"+u,JSON.stringify(user));
      localStorage.setItem("skynexa_loggedIn",u);
      currentUser=u;
      showDashboard();
    }
    if(pic){reader.readAsDataURL(pic);} else {
      let user={password:p, projects:{}, friends:[], profile:{name:u, desc:"", pic:"https://i.ibb.co/ZVFsg37/default.png"}};
      localStorage.setItem("user_"+u,JSON.stringify(user));
      localStorage.setItem("skynexa_loggedIn",u);
      currentUser=u;
      showDashboard();
    }
  }

  function logIn(){
    let u=document.getElementById("username").value.trim();
    let p=document.getElementById("password").value.trim();
    let data=localStorage.getItem("user_"+u);
    if(!data){alert("User not found");return;}
    let parsed=JSON.parse(data);
    if(parsed.password!==p){alert("Wrong password");return;}
    localStorage.setItem("skynexa_loggedIn",u);
    currentUser=u;
    showDashboard();
  }

  function logout(){
    localStorage.removeItem("skynexa_loggedIn");
    currentUser=null;
    document.getElementById("dashboard").style.display="none";
    document.getElementById("auth").style.display="flex";
  }

  // ===== DASHBOARD =====
  function showDashboard(){
    document.getElementById("auth").style.display="none";
    document.getElementById("workspace").style.display="none";
    document.getElementById("dashboard").style.display="flex";
    loadProfile();
    loadProjects();
    loadFriends();
  }

  function loadProfile(){
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    document.getElementById("profileImage").src=u.profile.pic;
    document.getElementById("displayName").innerText=u.profile.name;
    document.getElementById("displayDesc").innerText=u.profile.desc;
  }

  function loadProjects(){
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    let container=document.getElementById("projects");
    container.innerHTML="";
    for(let p in u.projects){
      let box=document.createElement("div");
      box.className="project-box";
      box.textContent=p;
      box.onclick=()=>openProject(p);
      container.appendChild(box);
    }
  }

  function createProject(name){
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    if(u.projects[name]){alert("Exists");return;}
    u.projects[name]={};
    localStorage.setItem("user_"+currentUser,JSON.stringify(u));
    openProject(name);
  }

  // ===== FRIEND LIST =====
  function loadFriends(){
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    let list=document.getElementById("friends");
    list.innerHTML="";
    u.friends.forEach(f=>{
      let li=document.createElement("li");
      li.textContent=f;
      list.appendChild(li);
    });
  }

  // ===== WORKSPACE =====
  function openProject(name){
    document.getElementById("dashboard").style.display="none";
    document.getElementById("workspace").style.display="flex";
    currentProject=name;
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    let fileList=document.getElementById("fileList");
    fileList.innerHTML="";
    for(let f in u.projects[name]){
      let li=document.createElement("li");
      li.textContent=f;
      li.onclick=()=>openFile(f);
      fileList.appendChild(li);
    }
    if(!editor){
      editor=ace.edit("editor");
      editor.setTheme("ace/theme/monokai");
    }
    editor.setValue("");
  }

  function openFile(fname){
    currentFile=fname;
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    editor.setValue(u.projects[currentProject][fname]||"");
    if(fname.endsWith(".css")) editor.session.setMode("ace/mode/css");
    else if(fname.endsWith(".js")) editor.session.setMode("ace/mode/javascript");
    else editor.session.setMode("ace/mode/html");
  }

  function saveFile(){
    if(!currentFile){alert("Add a file first");return;}
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    u.projects[currentProject][currentFile]=editor.getValue();
    localStorage.setItem("user_"+currentUser,JSON.stringify(u));
    alert("Saved");
    loadProjects();
  }

  function addFile(){
    let fname=prompt("File name?");
    if(!fname) return;
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    if(u.projects[currentProject][fname]){alert("Exists");return;}
    u.projects[currentProject][fname]="";
    localStorage.setItem("user_"+currentUser,JSON.stringify(u));
    openProject(currentProject);
    openFile(fname);
  }

  function previewProject(){
    let u=JSON.parse(localStorage.getItem("user_"+currentUser));
    let proj=u.projects[currentProject];
    if(!proj["index.html"]){alert("Need index.html");return;}
    let html=proj["index.html"];
    if(proj["style.css"]) html+="<style>"+proj["style.css"]+"</style>";
    if(proj["script.js"]) html+="<script>"+proj["script.js"]+"<\\/script>";
    document.getElementById("previewFrame").srcdoc=html;
    document.getElementById("previewArea").style.display="block";
  }

  function closePreview(){
    document.getElementById("previewArea").style.display="none";
  }

  // ===== EVENTS =====
  document.getElementById("signUpBtn").onclick=signUp;
  document.getElementById("logInBtn").onclick=logIn;
  document.getElementById("logoutBtn").onclick=logout;
  document.getElementById("newProjectBtn").onclick=()=>{
    let name=prompt("Project name?");
    if(name) createProject(name);
  };
  document.getElementById("saveBtn").onclick=saveFile;
  document.getElementById("previewBtn").onclick=previewProject;
  document.getElementById("closePreviewBtn").onclick=closePreview;
  document.getElementById("addFileBtn").onclick=addFile;
</script>
</body>
</html>
